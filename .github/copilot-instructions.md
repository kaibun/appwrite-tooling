# Appwrite Tooling - AI Coding Guidelines

## Architecture Overview

This is a **Docker Compose orchestration toolkit** for managing self-hosted Appwrite development stacks locally:

- **Core**: Bash scripts wrapping docker-compose operations 
- **Namespace Management**: Uses `COMPOSE_PROJECT_NAME` for container isolation
- **Backup/Restore**: Full MariaDB and volume backup system
- **Version Management**: Automated Appwrite version upgrades

## Critical Configuration Patterns

### Environment Requirements
The `.env` file **must** include:
```env
COMPOSE_PROJECT_NAME=[name of the current directory]
```
This prevents container name conflicts and ensures all scripts use consistent naming.

### Script Dependencies
All scripts require these system tools:
- Docker and Docker Compose
- `yq` (YAML processor) 
- `curl` and `diff`

## Essential Development Workflows

### Container Management
```bash
npm run up           # Start all services (docker compose up -d --remove-orphans)
npm run up:recreate  # Force recreate containers
npm run down         # Stop all services
npm run fix-network  # Fix Docker network issues
```

### Backup Operations
```bash
npm run backup       # Full backup to ./backups/YYYYMMDD_HHMMSS/
npm run restore      # Interactive restore from backup
npm run purge        # Clean all backups (be careful!)
```

### Version Management
```bash
npm run bump         # Bump Appwrite version in docker-compose.yml
npm run upgrade      # Upgrade Appwrite with backup safety
npm run migrate      # Run database migrations
```

## Project-Specific Conventions

### Script Architecture
- `scripts/utils.sh` - Shared utility functions
- Individual scripts source `utils.sh` for common operations
- All scripts use `set -e` for fail-fast behavior

### Backup Strategy
- **Database**: mysqldump of MariaDB container
- **Files**: tar archives of Docker volumes
- **Metadata**: Preserves container IDs and timestamps
- **Safety**: Always backup before upgrades

### Container Discovery
Scripts dynamically find containers by naming patterns:
```bash
# Finds containers with 'appwrite-mariadb' in name
find_mariadb_container()
```

## Integration Points

### Docker Compose Integration

- Relies on existing `docker-compose.yml` (generated by Appwrite installer)
- Extends compose with custom networking fixes
- Preserves Appwrite's official container configurations

### Appwrite Compatibility

- Supports Appwrite 1.7.4+ (check package.json version)
- Handles database schema migrations automatically
- Preserves authentication secrets and API keys

### Volume Management  

- Backs up persistent volumes: `appwrite-mariadb`, `appwrite-redis`, `appwrite-cache`
- Handles permission issues in container environments
- Uses docker cp for reliable volume access

When modifying scripts, always test backup/restore cycles. The system prioritizes data safety over convenience.